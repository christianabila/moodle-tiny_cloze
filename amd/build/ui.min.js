define("tiny_cloze/ui",["exports","core/modal_factory","./modal","core/mustache","core/str","./options"],(function(_exports,_modal_factory,_modal,_mustache,_str,_options){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Plugin tiny_cloze for TinyMCE v6 in Moodle.
   *
   * @module      tiny_cloze/ui
   * @copyright   2023 MoodleDACH
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.resolveSubquestion=_exports.onInit=_exports.displayDialogue=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal=_interopRequireDefault(_modal),_mustache=_interopRequireDefault(_mustache);const strdecode=t=>String(t).replace(/\\(#|\}|~)/g,"$1"),strencode=t=>String(t).replace(/(#|\}|~)/g,"\\$1"),CSS={ANSWER:"tiny_cloze_answer",ANSWERS:"tiny_cloze_answers",ADD:"tiny_cloze_add",CANCEL:"tiny_cloze_cancel",DELETE:"tiny_cloze_delete",FEEDBACK:"tiny_cloze_feedback",FRACTION:"tiny_cloze_fraction",LEFT:"tiny_cloze_col0",LOWER:"tiny_cloze_down",RIGHT:"tiny_cloze_col1",MARKS:"tiny_cloze_marks",DUPLICATE:"tiny_cloze_duplicate",RAISE:"tiny_cloze_up",SUBMIT:"tiny_cloze_submit",SUMMARY:"tiny_cloze_summary",TOLERANCE:"tiny_cloze_tolerance",TYPE:"tiny_cloze_qtype"},TEMPLATE_FORM="tiny_cloze/form",TEMPLATE_OUTPUT="&#123;{{marks}}:{{qtype}}:{{#answerdata}}~{{#if fraction}}%{{../fraction}}%{{/if}}{{answer}}{{#if tolerance}}:{{tolerance}}{{/if}}{{#if feedback}}#{{feedback}}{{/if}}{{/answerdata}}&#125;",TEMPLATE_TYPE="tiny_cloze/qtype",FRACTIONS=[{fraction:100},{fraction:50},{fraction:33.33333},{fraction:25},{fraction:20},{fraction:16.66667},{fraction:14.28571},{fraction:12.5},{fraction:11.11111},{fraction:10},{fraction:5},{fraction:0},{fraction:-5},{fraction:-10},{fraction:-11.11111},{fraction:-12.5},{fraction:-14.28571},{fraction:-16.66667},{fraction:-20},{fraction:-25},{fraction:-33.333},{fraction:-50},{fraction:-100}];let _form=null,_answerdata=[],_answerDefault="",_qtype=null,_selectedText=null,_marks=1,modal=null,_currentSelection=null;_exports.onInit=function(){document.querySelector("body#page-question-type-multianswer form, body#page-question-type-multianswerwiris form")};_exports.displayDialogue=async function(editor){_currentSelection=editor.selection.getContent(),""!==_currentSelection.toString().replace(/^\s+/,"").replace(/\s+$/,"")&&(_selectedText=_currentSelection.toString()),modal=await _modal_factory.default.create({type:_modal.default.TYPE,title:(0,_str.get_string)("imageproperties","tiny_media"),templateContext:{elementid:editor.id},removeOnClose:!0,large:!0});var subquestion=resolveSubquestion();subquestion?(_parseSubquestion(subquestion),modal.setBody(_getDialogueContent(null,_qtype))):modal.setBody(_getDialogueContent()),modal.show()};const _getDialogueContent=function(e,qtype){let content;return _form&&_form.remove().destroy(!0),qtype?(content=_mustache.default.render(TEMPLATE_FORM,{CSS:CSS,answerdata:_answerdata,elementid:crypto.randomUUID(),fractions:FRACTIONS,qtype:_qtype,marks:_marks,numerical:"NUMERICAL"===_qtype||"NM"===_qtype}),_form=content,content.querySelector("."+CSS.SUBMIT).on("click",_setSubquestion),content.querySelector("."+CSS.CANCEL).on("click",_cancel),content.delegate("click",_deleteAnswer,"."+CSS.DELETE),content.delegate("click",_addAnswer,"."+CSS.ADD),content.delegate("key",_addAnswer,"enter","."+CSS.ANSWER+", ."+CSS.FEEDBACK),content.delegate("click",_lowerAnswer,"."+CSS.LOWER),content.delegate("click",_raiseAnswer,"."+CSS.RAISE),content):(content=_mustache.default.render(TEMPLATE_TYPE,{CSS:CSS,qtype:_qtype,types:(0,_options.getQuestionTypes)()}),_form=content,content.delegate("click",_choiceHandler,"."+CSS.SUBMIT+", ."+CSS.DUPLICATE),content.querySelector("."+CSS.CANCEL).on("click",_cancel),content)},_getAnswerDefault=function(){switch(_qtype){case"SHORTANSWER":case"SA":case"NUMERICAL":case"NM":_answerDefault=100;break;default:_answerDefault=""}return _answerDefault},_choiceHandler=function(e){e.preventDefault();let qtype=_form.querySelector("input[name=qtype]:checked");qtype&&(_qtype=qtype.get("value"),_getAnswerDefault()),e&&e.currentTarget&&e.currentTarget.hasClass(CSS.SUBMIT)&&(_answerdata=[{id:crypto.randomUUID(),answer:_selectedText,feedback:"",fraction:100,tolerance:0}]),modal.setBody(_getDialogueContent(e,_qtype)),_form.querySelector("."+CSS.ANSWER).focus()},_parseSubquestion=function(question){const parts=/\{([0-9]*):([_A-Z]+):(.*?)\}$/g.exec(question);if(!parts)return;_marks=parts[1],_qtype=parts[2],_getAnswerDefault(),_answerdata=[];const answers=parts[3].match(/(\\.|[^~])*/g);answers&&answers.forEach((function(answer){const options=/^(%(-?[.0-9]+)%|(=?))((\\.|[^#])*)#?(.*)/.exec(answer);if(options&&options[4]){if("NUMERICAL"===_qtype||"NM"===_qtype){const tolerance=/^([^:]*):?(.*)/.exec(options[4])[2]||0;return void _answerdata.push({id:crypto.randomUUID(),answer:strdecode(options[4].replace(/:.*/,"")),feedback:strdecode(options[6]),tolerance:tolerance,fraction:options[3]?100:options[2]||0})}_answerdata.push({answer:strdecode(options[4]),id:crypto.randomUUID(),feedback:strdecode(options[6]),fraction:options[3]?100:options[2]||0})}}))},_addAnswer=function(e){e.preventDefault();let index=_form.querySelectorAll("."+CSS.ADD).indexOf(e.target);-1===index&&(index=_form.querySelectorAll("."+CSS.ANSWER+", ."+CSS.FEEDBACK).indexOf(e.target),-1!==index&&(index=Math.floor(index/2)+1)),e.target.closest("li")&&(_answerDefault=e.target.closest("li").querySelector("."+CSS.FRACTION).getDOMNode().value,index=_form.querySelectorAll("li").indexOf(e.target.closest("li"))+1);let tolerance=0;e.target.closest("li")&&e.target.closest("li").one("."+CSS.TOLERANCE)&&(tolerance=e.target.closest("li").querySelector("."+CSS.TOLERANCE).getDOMNode().value),_getFormData(),_answerdata.splice(index,0,{id:crypto.randomUUID(),answer:"",feedback:"",fraction:_answerDefault,tolerance:tolerance}),modal.setBody(_getDialogueContent(e,_qtype)),_form.querySelectorAll("."+CSS.ANSWER).item(index).focus()},_deleteAnswer=function(e){e.preventDefault();let index=_form.querySelectorAll("."+CSS.DELETE).indexOf(e.target);-1===index&&(index=_form.querySelectorAll("li").indexOf(e.target.closest("li"))),_getFormData(),_answerdata.splice(index,1),modal.setBody(_getDialogueContent(e,_qtype));const answers=_form.querySelectorAll("."+CSS.ANSWER);index=Math.min(index,answers.size()-1),answers.item(index).focus()},_lowerAnswer=function(e){e.preventDefault();const li=e.target.closest("li");li.insertBefore(li.next(),li),li.querySelector("."+CSS.ANSWER).focus()},_raiseAnswer=function(e){e.preventDefault();const li=e.target.closest("li");li.insertBefore(li,li.previous()),li.querySelector("."+CSS.ANSWER).focus()},_cancel=function(e){e.preventDefault(),modal.hide()},_setSubquestion=function(e,editor){e.preventDefault(),_getFormData(),_answerdata.forEach((function(option){option.answer=strencode(option.answer),option.feedback=strencode(option.feedback)}));const question=_mustache.default.render(TEMPLATE_OUTPUT,{CSS:CSS,answerdata:_answerdata,qtype:_qtype,marks:_marks});modal.hide(),editor.focus(),editor.setSelection(_currentSelection);let selection=window.rangy.saveSelection();editor.insertContent(question),window.rangy.restoreSelection(selection)},_getFormData=function(){let answer;_answerdata=[];const answers=_form.querySelectorAll("."+CSS.ANSWER),feedbacks=_form.querySelectorAll("."+CSS.FEEDBACK),fractions=_form.querySelectorAll("."+CSS.FRACTION),tolerances=_form.querySelectorAll("."+CSS.TOLERANCE);for(let i=0;i<answers.size();i++)answer=answers.item(i).getDOMNode().value,"NM"!==this._qtype&&"NUMERICAL"!==this._qtype||(answer=Number(answer)),_answerdata.push({answer:answer,id:crypto.randomUUID(),feedback:feedbacks.item(i).getDOMNode().value,fraction:fractions.item(i).getDOMNode().value,tolerance:tolerances.item(i)?tolerances.item(i).getDOMNode().value:0}),_marks=_form.querySelector("."+CSS.MARKS).getDOMNode().value},_getAnchor=function(node,offset){if(!node.hasChildNodes())return{anchor:node,offset:offset};let child=node.firstChild;for(;offset>child.textContent.length;)offset-=child.textContent.length,child=child.nextSibling;return _getAnchor(child,offset)},_getOffset=function(container,node){if(container===node)return 0;if(!container.contains(node))return 0;let offset=0,child=container.firstChild;for(;!child.contains(node);)offset+=child.textContent.length,child=child.nextSibling;return offset+_getOffset(child,node)},resolveSubquestion=function(editor){let node=editor.selection.getStart();if(!node)return!1;const selectedNode=node.parent();if(!selectedNode)return!1;const subquestions=selectedNode.textContent.match(/\{[0-9]*:(\\.|[^}])*?\}/g);if(!subquestions)return!1;let index=null;const selection=editor.selection.getContent();let result="",questionEnd=0;if(!selection||0===selection.length)return!1;const startIndex=_getIndex(selectedNode,selection[0].startContainer,selection[0].startOffset),endIndex=_getIndex(selectedNode,selection[0].endContainer,selection[0].endOffset);return subquestions.forEach((function(subquestion){if(index=selectedNode.textContent.indexOf(subquestion,questionEnd),questionEnd=index+subquestion.length,index<=startIndex&&endIndex<=questionEnd){result=subquestion;const startRange=_getAnchor(selectedNode,index),endRange=_getAnchor(selectedNode,questionEnd);selection[0].setStart(startRange.anchor,startRange.offset),selection[0].setEnd(endRange.anchor,endRange.offset),_currentSelection=selection}})),result};_exports.resolveSubquestion=resolveSubquestion;const _getIndex=function(selectedNode,container,offset){let index;return index=container.firstChild?container.childNodes[offset]?_getOffset(selectedNode,container.childNodes[offset]):_getOffset(selectedNode,container.lastChild)+container.lastChild.textContent.length:_getOffset(selectedNode,container)+offset,index}}));

//# sourceMappingURL=ui.min.js.map