define("tiny_cloze/ui",["exports","core/modal_factory","./modal","core/mustache","core/str"],(function(_exports,_modal_factory,_modal,_mustache,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Plugin tiny_cloze for TinyMCE v6 in Moodle.
   *
   * @module      tiny_cloze/ui
   * @copyright   2023 MoodleDACH
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.resolveSubquestion=_exports.onInit=_exports.displayDialogue=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal=_interopRequireDefault(_modal),_mustache=_interopRequireDefault(_mustache);const strdecode=t=>String(t).replace(/\\(#|\}|~)/g,"$1"),strencode=t=>String(t).replace(/(#|\}|~)/g,"\\$1"),CSS={ANSWER:"tiny_cloze_answer",ANSWERS:"tiny_cloze_answers",ADD:"tiny_cloze_add",CANCEL:"tiny_cloze_cancel",DELETE:"tiny_cloze_delete",FEEDBACK:"tiny_cloze_feedback",FRACTION:"tiny_cloze_fraction",LEFT:"tiny_cloze_col0",LOWER:"tiny_cloze_down",RIGHT:"tiny_cloze_col1",MARKS:"tiny_cloze_marks",DUPLICATE:"tiny_cloze_duplicate",RAISE:"tiny_cloze_up",SUBMIT:"tiny_cloze_submit",SUMMARY:"tiny_cloze_summary",TOLERANCE:"tiny_cloze_tolerance",TYPE:"tiny_cloze_qtype"},TEMPLATE={FORM:'<div class="tiny_cloze"><p class="ml-2">{{qtype}}</p><form class="tiny_form"><div class="row ml-0"><div class="form-group"><label for="{{elementid}}_mark">{{get_string "defaultmark" "question"}}</label><input id="{{elementid}}_mark" type="text" value="{{marks}}" class="{{CSS.MARKS}} form-control d-inline mx-1" /><a class="{{CSS.ADD}}" title="{{get_string "addmoreanswerblanks" "qtype_calculated"}}"><img class="icon_smallicon" src="'+M.util.image_url("t/add","core")+'"></a></div></div><div class="{{CSS.ANSWERS}} mb-3"><ol class="pl-3">{{#answerdata}}<li class="mt-3"><div class="row ml-0"><div class="{{../CSS.LEFT}} form-group"><label for="{{id}}_answer">{{get_string "answer" "question"}}</label><input id="{{id}}_answer" type="text" value="{{answer}}" class="{{../CSS.ANSWER}} form-control d-inline mx-2" /></div><div class="{{../CSS.LEFT}} form-group"><a class="{{../CSS.ADD}}" title="{{get_string "addmoreanswerblanks" "qtype_calculated"}}"><img class="icon_smallicon" src="'+M.util.image_url("t/add","core")+'"></a><a class="{{../CSS.DELETE}}" title="{{get_string "delete" "core"}}"><img class="icon_smallicon" src="'+M.util.image_url("t/delete","core")+'"></a><a class="{{../CSS.RAISE}}" title="{{get_string "up" "core"}}"><img class="icon_smallicon" src="'+M.util.image_url("t/up","core")+'"></a><a class="{{../CSS.LOWER}}" title="{{get_string "down" "core"}}"><img class="icon_smallicon" src="'+M.util.image_url("t/down","core")+'"></a></div></div>{{#if ../numerical}}<div class="row"><div class="{{../CSS.RIGHT}} form-group"><label for="{{id}}_tolerance">{{{get_string "tolerance" "qtype_calculated"}}}</label><input id="{{id}}_tolerance" type="text" value="{{tolerance}}" class="{{../../CSS.TOLERANCE}} form-control d-inline mx-2" /></div></div>{{/if}}<div class="row"><div class="{{../CSS.RIGHT}} form-group"><label for="{{id}}_feedback">{{get_string "feedback" "question"}}</label><input id="{{id}}_feedback" type="text" value="{{feedback}}" class="{{../CSS.FEEDBACK}} form-control d-inline mx-2" /></div><div class="{{../CSS.RIGHT}} form-group"><label id="{{id}}_grade">{{get_string "grade" "grades"}}</label><select id="{{id}}_grade" value="{{fraction}}" class="{{../CSS.FRACTION}} custom-select mx-2" selected>{{#if fraction}}<option value="{{../fraction}}">{{../fraction}}%</option>{{/if}}<option value="">{{get_string "incorrect" "question"}}</option>{{#../fractions}}<option value="{{fraction}}">{{fraction}}%</option>{{/../fractions}}</select></div></div></li>{{/answerdata}}</ol></div><p class="mb-0"><button type="submit" class="{{CSS.SUBMIT}} btn btn-primary mr-1" title="{{get_string "common:insert" "editor_tinymce"}}">{{get_string "common:insert" "editor_tinymce"}}</button><button type="submit" class="{{CSS.CANCEL}} btn btn-secondary">{{get_string "cancel" "core"}}</button></p></form></div>',OUTPUT:"&#123;{{marks}}:{{qtype}}:{{#answerdata}}~{{#if fraction}}%{{../fraction}}%{{/if}}{{answer}}{{#if tolerance}}:{{tolerance}}{{/if}}{{#if feedback}}#{{feedback}}{{/if}}{{/answerdata}}&#125;",TYPE:'<div class="tiny_cloze mt-0 mx-2 mb-2"><p>{{get_string "chooseqtypetoadd" "question"}}</p><form ="tiny_form"><div class="{{CSS.TYPE}} form-check">{{#types}}<div class="option"><input name="qtype" id="qtype_qtype_{{type}}" value="{{type}}" type="radio" class="form-check-input"><label for="qtype_qtype_{{type}}"><span class="typename">{{type}}</span><span class="{{../CSS.SUMMARY}}"><h6>{{name}}</h6><p>{{summary}}</p><ul>{{#options}}<li>{{option}}</li>{{/options}}</ul></span></label></div>{{/types}}</div><p class="mb-0"><button type="submit" class="{{CSS.SUBMIT}} btn btn-primary mr-1" title="{{get_string "add" "core"}}">{{get_string "add" "core"}}</button>{{#qtype}}<button type="submit" class="{{../CSS.DUPLICATE}} btn btn-secondary mr-1">{{get_string "duplicate" "core"}}</button>{{/qtype}}<button type="submit" class="{{CSS.CANCEL}} btn btn-secondary">{{get_string "cancel" "core"}}</button></p></form></div>'},FRACTIONS=[{fraction:100},{fraction:50},{fraction:33.33333},{fraction:25},{fraction:20},{fraction:16.66667},{fraction:14.28571},{fraction:12.5},{fraction:11.11111},{fraction:10},{fraction:5},{fraction:0},{fraction:-5},{fraction:-10},{fraction:-11.11111},{fraction:-12.5},{fraction:-14.28571},{fraction:-16.66667},{fraction:-20},{fraction:-25},{fraction:-33.333},{fraction:-50},{fraction:-100}];let _form=null,_answerdata=[],_answerDefault="",_qtype=null,_selectedText=null,_marks=1,modal=null,_currentSelection=null;_exports.onInit=function(){document.querySelector("body#page-question-type-multianswer form, body#page-question-type-multianswerwiris form")};_exports.displayDialogue=async function(editor){if(_currentSelection=editor.selection.getContent(),""!==_currentSelection.toString().replace(/^\s+/,"").replace(/\s+$/,"")){_selectedText=_currentSelection.toString(),modal=await _modal_factory.default.create({type:_modal.default.TYPE,title:(0,_str.get_string)("imageproperties","tiny_media"),templateContext:{elementid:editor.getId()},removeOnClose:!0,large:!0});var subquestion=resolveSubquestion();subquestion?(_parseSubquestion(subquestion),modal.setBody(_getDialogueContent(null,_qtype))):modal.setBody(_getDialogueContent()),modal.show()}};const _getDialogueContent=function(e,qtype){let content;return _form&&_form.remove().destroy(!0),qtype?(content=_mustache.default.render(TEMPLATE.FORM,{CSS:CSS,answerdata:_answerdata,elementid:crypto.randomUUID(),fractions:FRACTIONS,qtype:_qtype,marks:_marks,numerical:"NUMERICAL"===_qtype||"NM"===_qtype}),_form=content,content.querySelector("."+CSS.SUBMIT).on("click",_setSubquestion),content.querySelector("."+CSS.CANCEL).on("click",_cancel),content.delegate("click",_deleteAnswer,"."+CSS.DELETE),content.delegate("click",_addAnswer,"."+CSS.ADD),content.delegate("key",_addAnswer,"enter","."+CSS.ANSWER+", ."+CSS.FEEDBACK),content.delegate("click",_lowerAnswer,"."+CSS.LOWER),content.delegate("click",_raiseAnswer,"."+CSS.RAISE),content):(content=_mustache.default.render(TEMPLATE.TYPE,{CSS:CSS,qtype:this._qtype,types:this.get("questiontypes")}),_form=content,content.delegate("click",_choiceHandler,"."+CSS.SUBMIT+", ."+CSS.DUPLICATE),content.querySelector("."+CSS.CANCEL).on("click",_cancel),content)},_getAnswerDefault=function(){switch(_qtype){case"SHORTANSWER":case"SA":case"NUMERICAL":case"NM":_answerDefault=100;break;default:_answerDefault=""}return _answerDefault},_choiceHandler=function(e){e.preventDefault();let qtype=_form.querySelector("input[name=qtype]:checked");qtype&&(_qtype=qtype.get("value"),_getAnswerDefault()),e&&e.currentTarget&&e.currentTarget.hasClass(CSS.SUBMIT)&&(_answerdata=[{id:crypto.randomUUID(),answer:_selectedText,feedback:"",fraction:100,tolerance:0}]),modal.setBody(_getDialogueContent(e,_qtype)),_form.querySelector("."+CSS.ANSWER).focus()},_parseSubquestion=function(question){const parts=/\{([0-9]*):([_A-Z]+):(.*?)\}$/g.exec(question);if(!parts)return;_marks=parts[1],_qtype=parts[2],_getAnswerDefault(),_answerdata=[];const answers=parts[3].match(/(\\.|[^~])*/g);answers&&answers.forEach((function(answer){const options=/^(%(-?[.0-9]+)%|(=?))((\\.|[^#])*)#?(.*)/.exec(answer);if(options&&options[4]){if("NUMERICAL"===_qtype||"NM"===_qtype){const tolerance=/^([^:]*):?(.*)/.exec(options[4])[2]||0;return void _answerdata.push({id:crypto.randomUUID(),answer:strdecode(options[4].replace(/:.*/,"")),feedback:strdecode(options[6]),tolerance:tolerance,fraction:options[3]?100:options[2]||0})}_answerdata.push({answer:strdecode(options[4]),id:crypto.randomUUID(),feedback:strdecode(options[6]),fraction:options[3]?100:options[2]||0})}}))},_addAnswer=function(e){e.preventDefault();let index=_form.querySelectorAll("."+CSS.ADD).indexOf(e.target);-1===index&&(index=_form.querySelectorAll("."+CSS.ANSWER+", ."+CSS.FEEDBACK).indexOf(e.target),-1!==index&&(index=Math.floor(index/2)+1)),e.target.closest("li")&&(_answerDefault=e.target.closest("li").querySelector("."+CSS.FRACTION).getDOMNode().value,index=_form.querySelectorAll("li").indexOf(e.target.closest("li"))+1);let tolerance=0;e.target.closest("li")&&e.target.closest("li").one("."+CSS.TOLERANCE)&&(tolerance=e.target.closest("li").querySelector("."+CSS.TOLERANCE).getDOMNode().value),_getFormData(),_answerdata.splice(index,0,{id:crypto.randomUUID(),answer:"",feedback:"",fraction:_answerDefault,tolerance:tolerance}),modal.setBody(_getDialogueContent(e,_qtype)),_form.querySelectorAll("."+CSS.ANSWER).item(index).focus()},_deleteAnswer=function(e){e.preventDefault();let index=_form.querySelectorAll("."+CSS.DELETE).indexOf(e.target);-1===index&&(index=_form.querySelectorAll("li").indexOf(e.target.closest("li"))),_getFormData(),_answerdata.splice(index,1),modal.setBody(_getDialogueContent(e,_qtype));const answers=_form.querySelectorAll("."+CSS.ANSWER);index=Math.min(index,answers.size()-1),answers.item(index).focus()},_lowerAnswer=function(e){e.preventDefault();const li=e.target.closest("li");li.insertBefore(li.next(),li),li.querySelector("."+CSS.ANSWER).focus()},_raiseAnswer=function(e){e.preventDefault();const li=e.target.closest("li");li.insertBefore(li,li.previous()),li.querySelector("."+CSS.ANSWER).focus()},_cancel=function(e){e.preventDefault(),modal.hide()},_setSubquestion=function(e,editor){e.preventDefault(),_getFormData(),_answerdata.forEach((function(option){option.answer=strencode(option.answer),option.feedback=strencode(option.feedback)}));const question=_mustache.default.render(TEMPLATE.OUTPUT,{CSS:CSS,answerdata:_answerdata,qtype:_qtype,marks:_marks});modal.hide(),editor.focus(),editor.setSelection(_currentSelection);let selection=window.rangy.saveSelection();editor.insertContent(question),window.rangy.restoreSelection(selection)},_getFormData=function(){let answer;_answerdata=[];const answers=_form.querySelectorAll("."+CSS.ANSWER),feedbacks=_form.querySelectorAll("."+CSS.FEEDBACK),fractions=_form.querySelectorAll("."+CSS.FRACTION),tolerances=_form.querySelectorAll("."+CSS.TOLERANCE);for(let i=0;i<answers.size();i++)answer=answers.item(i).getDOMNode().value,"NM"!==this._qtype&&"NUMERICAL"!==this._qtype||(answer=Number(answer)),_answerdata.push({answer:answer,id:crypto.randomUUID(),feedback:feedbacks.item(i).getDOMNode().value,fraction:fractions.item(i).getDOMNode().value,tolerance:tolerances.item(i)?tolerances.item(i).getDOMNode().value:0}),_marks=_form.querySelector("."+CSS.MARKS).getDOMNode().value},_getAnchor=function(node,offset){if(!node.hasChildNodes())return{anchor:node,offset:offset};let child=node.firstChild;for(;offset>child.textContent.length;)offset-=child.textContent.length,child=child.nextSibling;return _getAnchor(child,offset)},_getOffset=function(container,node){if(container===node)return 0;if(!container.contains(node))return 0;let offset=0,child=container.firstChild;for(;!child.contains(node);)offset+=child.textContent.length,child=child.nextSibling;return offset+_getOffset(child,node)},resolveSubquestion=function(editor){let node=editor.selection.getStart();if(!node)return!1;const selectedNode=node.parent();if(!selectedNode)return!1;const subquestions=selectedNode.textContent.match(/\{[0-9]*:(\\.|[^}])*?\}/g);if(!subquestions)return!1;let index=null;const selection=editor.selection.getContent();let result="",questionEnd=0;if(!selection||0===selection.length)return!1;const startIndex=_getIndex(selectedNode,selection[0].startContainer,selection[0].startOffset),endIndex=_getIndex(selectedNode,selection[0].endContainer,selection[0].endOffset);return subquestions.forEach((function(subquestion){if(index=selectedNode.textContent.indexOf(subquestion,questionEnd),questionEnd=index+subquestion.length,index<=startIndex&&endIndex<=questionEnd){result=subquestion;const startRange=_getAnchor(selectedNode,index),endRange=_getAnchor(selectedNode,questionEnd);selection[0].setStart(startRange.anchor,startRange.offset),selection[0].setEnd(endRange.anchor,endRange.offset),_currentSelection=selection}})),result};_exports.resolveSubquestion=resolveSubquestion;const _getIndex=function(selectedNode,container,offset){let index;return index=container.firstChild?container.childNodes[offset]?_getOffset(selectedNode,container.childNodes[offset]):_getOffset(selectedNode,container.lastChild)+container.lastChild.textContent.length:_getOffset(selectedNode,container)+offset,index}}));

//# sourceMappingURL=ui.min.js.map