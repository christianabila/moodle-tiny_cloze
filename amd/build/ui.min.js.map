{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Plugin tiny_cloze for TinyMCE v6 in Moodle.\n *\n * @module      tiny_cloze/ui\n * @copyright   2023 MoodleDACH\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalFactory from 'core/modal_factory';\nimport Modal from \"./modal\";\nimport Mustache from 'core/mustache';\nimport {get_string} from 'core/str';\nimport {getQuestionTypes} from './options';\n\nconst trim = v => v.toString().replace(/^\\s+/, '').replace(/\\s+$/, '');\nconst strdecode = t => String(t).replace(/\\\\(#|\\}|~)/g, '$1');\nconst strencode = t => String(t).replace(/(#|\\}|~)/g, '\\\\$1');\n\nconst CSS = {\n  ANSWER: 'tiny_cloze_answer',\n  ANSWERS: 'tiny_cloze_answers',\n  ADD: 'tiny_cloze_add',\n  CANCEL: 'tiny_cloze_cancel',\n  DELETE: 'tiny_cloze_delete',\n  FEEDBACK: 'tiny_cloze_feedback',\n  FRACTION: 'tiny_cloze_fraction',\n  LEFT: 'tiny_cloze_col0',\n  LOWER: 'tiny_cloze_down',\n  RIGHT: 'tiny_cloze_col1',\n  MARKS: 'tiny_cloze_marks',\n  DUPLICATE: 'tiny_cloze_duplicate',\n  RAISE: 'tiny_cloze_up',\n  SUBMIT: 'tiny_cloze_submit',\n  SUMMARY: 'tiny_cloze_summary',\n  TOLERANCE: 'tiny_cloze_tolerance',\n  TYPE: 'tiny_cloze_qtype'\n};\nconst TEMPLATE = {\n    FORM: '<div class=\"tiny_cloze\">' +\n      '<p class=\"ml-2\">{{qtype}}</p>' +\n      '<form class=\"tiny_form\">' +\n      '<div class=\"row ml-0\">' +\n      '<div class=\"form-group\">' +\n      '<label for=\"{{elementid}}_mark\">{{get_string \"defaultmark\" \"question\"}}</label>' +\n      '<input id=\"{{elementid}}_mark\" type=\"text\" value=\"{{marks}}\" ' +\n      'class=\"{{CSS.MARKS}} form-control d-inline mx-1\" />' +\n      '<a class=\"{{CSS.ADD}}\" title=\"{{get_string \"addmoreanswerblanks\" \"qtype_calculated\"}}\">' +\n      '<img class=\"icon_smallicon\" src=\"' +\n      M.util.image_url('t/add', 'core') + '\"></a>' +\n      '</div>' +\n      '</div>' +\n      '<div class=\"{{CSS.ANSWERS}} mb-3\">' +\n      '<ol class=\"pl-3\">{{#answerdata}}' +\n      '<li class=\"mt-3\"><div class=\"row ml-0\">' +\n      '<div class=\"{{../CSS.LEFT}} form-group\">' +\n      '<label for=\"{{id}}_answer\">{{get_string \"answer\" \"question\"}}</label>' +\n      '<input id=\"{{id}}_answer\" type=\"text\" value=\"{{answer}}\" ' +\n      'class=\"{{../CSS.ANSWER}} form-control d-inline mx-2\" />' +\n      '</div>' +\n      '<div class=\"{{../CSS.LEFT}} form-group\">' +\n      '<a class=\"{{../CSS.ADD}}\" title=\"{{get_string \"addmoreanswerblanks\" \"qtype_calculated\"}}\">' +\n      '<img class=\"icon_smallicon\" src=\"' +\n      M.util.image_url('t/add', 'core') + '\"></a>' +\n      '<a class=\"{{../CSS.DELETE}}\" title=\"{{get_string \"delete\" \"core\"}}\">' +\n      '<img class=\"icon_smallicon\" src=\"' +\n      M.util.image_url('t/delete', 'core') + '\"></a>' +\n      '<a class=\"{{../CSS.RAISE}}\" title=\"{{get_string \"up\" \"core\"}}\">' +\n      '<img class=\"icon_smallicon\" src=\"' +\n      M.util.image_url('t/up', 'core') + '\"></a>' +\n      '<a class=\"{{../CSS.LOWER}}\" title=\"{{get_string \"down\" \"core\"}}\">' +\n      '<img class=\"icon_smallicon\" src=\"' +\n      M.util.image_url('t/down', 'core') + '\"></a>' +\n      '</div>' +\n      '</div>' +\n      '{{#if ../numerical}}' +\n      '<div class=\"row\">' +\n      '<div class=\"{{../CSS.RIGHT}} form-group\">' +\n      '<label for=\"{{id}}_tolerance\">{{{get_string \"tolerance\" \"qtype_calculated\"}}}</label>' +\n      '<input id=\"{{id}}_tolerance\" type=\"text\" value=\"{{tolerance}}\" ' +\n      'class=\"{{../../CSS.TOLERANCE}} form-control d-inline mx-2\" />' +\n      '</div>' +\n      '</div>' +\n      '{{/if}}' +\n      '<div class=\"row\">' +\n      '<div class=\"{{../CSS.RIGHT}} form-group\">' +\n      '<label for=\"{{id}}_feedback\">{{get_string \"feedback\" \"question\"}}</label>' +\n      '<input id=\"{{id}}_feedback\" type=\"text\" value=\"{{feedback}}\" ' +\n      'class=\"{{../CSS.FEEDBACK}} form-control d-inline mx-2\" />' +\n      '</div>' +\n      '<div class=\"{{../CSS.RIGHT}} form-group\">' +\n      '<label id=\"{{id}}_grade\">{{get_string \"grade\" \"grades\"}}</label>' +\n      '<select id=\"{{id}}_grade\" value=\"{{fraction}}\" class=\"{{../CSS.FRACTION}} custom-select mx-2\" selected>' +\n      '{{#if fraction}}' +\n      '<option value=\"{{../fraction}}\">{{../fraction}}%</option>' +\n      '{{/if}}' +\n      '<option value=\"\">{{get_string \"incorrect\" \"question\"}}</option>' +\n      '{{#../fractions}}' +\n      '<option value=\"{{fraction}}\">{{fraction}}%</option>' +\n      '{{/../fractions}}' +\n      '</select>' +\n      '</div>' +\n      '</div></li>' +\n      '{{/answerdata}}</ol></div>' +\n      '<p class=\"mb-0\"><button type=\"submit\" class=\"{{CSS.SUBMIT}} btn btn-primary mr-1\" ' +\n      'title=\"{{get_string \"common:insert\" \"editor_tinymce\"}}\">' +\n      '{{get_string \"common:insert\" \"editor_tinymce\"}}</button>' +\n      '<button type=\"submit\" class=\"{{CSS.CANCEL}} btn btn-secondary\">{{get_string \"cancel\" \"core\"}}</button></p>' +\n      '</form>' +\n      '</div>',\n    OUTPUT: '&#123;{{marks}}:{{qtype}}:{{#answerdata}}~{{#if fraction}}%{{../fraction}}%{{/if}}{{answer}}' +\n      '{{#if tolerance}}:{{tolerance}}{{/if}}' +\n      '{{#if feedback}}#{{feedback}}{{/if}}{{/answerdata}}&#125;',\n    TYPE: '<div class=\"tiny_cloze mt-0 mx-2 mb-2\">' +\n      '<p>{{get_string \"chooseqtypetoadd\" \"question\"}}</p>' +\n      '<form =\"tiny_form\">' +\n      '<div class=\"{{CSS.TYPE}} form-check\">' +\n      '{{#types}}' +\n      '<div class=\"option\">' +\n      '<input name=\"qtype\" id=\"qtype_qtype_{{type}}\" value=\"{{type}}\" type=\"radio\" class=\"form-check-input\">' +\n      '<label for=\"qtype_qtype_{{type}}\">' +\n      '<span class=\"typename\">{{type}}</span>' +\n      '<span class=\"{{../CSS.SUMMARY}}\"><h6>{{name}}</h6><p>{{summary}}</p>' +\n      '<ul>{{#options}}' +\n      '<li>{{option}}</li>' +\n      '{{/options}}</ul>' +\n      '</span>' +\n      '</label></div>' +\n      '{{/types}}</div>' +\n      '<p class=\"mb-0\"><button type=\"submit\" class=\"{{CSS.SUBMIT}} btn btn-primary mr-1\" ' +\n      'title=\"{{get_string \"add\" \"core\"}}\">{{get_string \"add\" \"core\"}}</button>' +\n      '{{#qtype}}<button type=\"submit\" class=\"{{../CSS.DUPLICATE}} btn btn-secondary mr-1\">' +\n      '{{get_string \"duplicate\" \"core\"}}</button>{{/qtype}}' +\n      '<button type=\"submit\" class=\"{{CSS.CANCEL}} btn btn-secondary\">{{get_string \"cancel\" \"core\"}}</button></p>' +\n      '</form></div>',\n  };\n  const FRACTIONS = [{fraction: 100},\n    {fraction: 50},\n    {fraction: 33.33333},\n    {fraction: 25},\n    {fraction: 20},\n    {fraction: 16.66667},\n    {fraction: 14.28571},\n    {fraction: 12.5},\n    {fraction: 11.11111},\n    {fraction: 10},\n    {fraction: 5},\n    {fraction: 0},\n    {fraction: -5},\n    {fraction: -10},\n    {fraction: -11.11111},\n    {fraction: -12.5},\n    {fraction: -14.28571},\n    {fraction: -16.66667},\n    {fraction: -20},\n    {fraction: -25},\n    {fraction: -33.333},\n    {fraction: -50},\n    {fraction: -100},\n  ];\n\n  let editor = null;\n\n  /**\n   * A reference to the currently open form.\n   *\n   * @param _form\n   * @type Node\n   * @private\n   */\n  let _form = null;\n\n  /**\n   * An array containing the current answers options\n   *\n   * @param _answerdata\n   * @type Array\n   * @private\n   */\n  let _answerdata = [];\n\n  let _answerDefault = '';\n  /**\n   * The sub question type to be edited\n   *\n   * @param _qtype\n   * @type String\n   * @private\n   */\n  let _qtype = null;\n\n  /**\n   * The text initial selected to use as answer default\n   *\n   * @param _selectedText\n   * @type String\n   * @private\n   */\n  let _selectedText = null;\n\n\n  /**\n   * The maximum marks for the sub question\n   *\n   * @param _marks\n   * @type Integer\n   * @private\n   */\n  let _marks = 1;\n\n/**\n * The modal dialogue to be displayed when designing the cloze question types.\n * @type {null}\n */\nlet modal = null;\n\n  /**\n   * The selection object returned by the browser.\n   *\n   * @type Range|null\n   * @default null\n   */\n  let _currentSelection = null;\n\n  const onInit = function(ed) {\n    editor = ed;\n  };\n\n/**\n * Display form to edit subquestions.\n *\n * @method displayDialogue\n * @private\n */\nconst displayDialogue = async function() {\n  // Store the current selection.\n  _currentSelection = editor.selection.getContent();\n  if (trim(_currentSelection) !== '') {\n    // Save selected string to set answer default answer.\n    _selectedText = _currentSelection.toString();\n  }\n  modal = await ModalFactory.create({\n    type: Modal.TYPE,\n    title: get_string('button_clozeedit', 'tiny_cloze'),\n    templateContext: {\n      elementid: editor.id\n    },\n    removeOnClose: true,\n    large: true,\n  });\n\n  // Resolve whether cursor is in a subquestion.\n  var subquestion = resolveSubquestion(editor);\n  if (subquestion) {\n    _parseSubquestion(subquestion);\n    modal.setBody(_getDialogueContent(null, _qtype));\n  } else {\n    const text = _getDialogueContent();\n    modal.setBody(text);\n  }\n  modal.show();\n};\n\n\n  /**\n   * Return the dialogue content for the tool, attaching any required\n   * events.\n   *\n   * @method _getDialogueContent\n   * @param {Event} e The event causing content to change\n   * @param {String} qtype The question type to be used\n   * @return {Node} The content to place in the dialogue.\n   * @private\n   */\n  const _getDialogueContent = function(e, qtype) {\n\n    if (_form) {\n      //_form.remove().destroy(true);\n    }\n\n    if (!qtype) {\n      const contentText = Mustache.render(TEMPLATE.TYPE, {CSS: CSS,\n        qtype: _qtype,\n        types: getQuestionTypes(editor)\n      });\n      const dom = new DOMParser();\n      const content = dom.parseFromString(contentText, 'text/html').body.firstElementChild;\n      _form = content;\n\n      content.addEventListener('click', _choiceHandler,\n        '.' + CSS.SUBMIT + ', .' + CSS.DUPLICATE);\n      content.querySelector('.' + CSS.CANCEL).addEventListener('click', _cancel);\n      return content.outerHTML;\n    }\n\n    const contentText = Mustache.render(TEMPLATE.FORM, {CSS: CSS,\n      answerdata: _answerdata,\n      elementid: crypto.randomUUID(),\n      fractions: FRACTIONS,\n      qtype: _qtype,\n      marks: _marks,\n      numerical: (_qtype === 'NUMERICAL' || _qtype === 'NM')\n    });\n\n    const dom = new DOMParser();\n    const content = dom.parseFromString(contentText, 'text/html').body.firstElementChild;\n    _form = content;\n\n    content.querySelector('.' + CSS.SUBMIT).addEventListener('click', _setSubquestion);\n    content.querySelector('.' + CSS.CANCEL).addEventListener('click', _cancel);\n    content.addEventListener('click', e => {\n      if (e.target.classList.contains(CSS.DELETE)) {\n        _deleteAnswer(e);\n        return;\n      }\n      if (e.target.classList.contains(CSS.ADD)) {\n        _addAnswer(e);\n        return;\n      }\n      if (e.target.classList.contains(CSS.LOWER)) {\n        _lowerAnswer(e);\n        return;\n      }\n      if (e.target.classList.contains(CSS.RAISE)) {\n        _raiseAnswer(e);\n        return;\n      }\n    });\n    content.addEventListener('keyup', e => {\n      if (e.target.classList.contains(CSS.ANSWER) || e.target.classList.contains(CSS.FEEDBACK)) {\n        _addAnswer(e);\n      }\n    });\n    return content.outerHTML;\n  };\n\n  /**\n   * Find the correct answer default for the current question type\n   *\n   * @method _getAnswerDefault\n   * @private\n   * @return {String} Default answer\n   */\n  const _getAnswerDefault = function() {\n    switch (_qtype) {\n      case 'SHORTANSWER':\n      case 'SA':\n      case 'NUMERICAL':\n      case 'NM':\n        _answerDefault = 100;\n        break;\n      default:\n        _answerDefault = '';\n    }\n    return _answerDefault;\n  };\n\n  /**\n   * Handle question choice\n   *\n   * @method _choiceHandler\n   * @private\n   * @param {Event} e Event from button click in chooser\n   */\n  const _choiceHandler = function(e) {\n    e.preventDefault();\n    let qtype = _form.querySelector('input[name=qtype]:checked');\n    if (qtype) {\n      _qtype = qtype.get('value');\n      _getAnswerDefault();\n    }\n    if (e && e.currentTarget && e.currentTarget.hasClass(CSS.SUBMIT)) {\n      _answerdata = [\n        {\n          id: crypto.randomUUID(),\n          answer: _selectedText,\n          feedback: '',\n          fraction: 100,\n          tolerance: 0\n        }\n      ];\n    }\n    modal.setBody(_getDialogueContent(e, _qtype));\n    _form.querySelector('.' + CSS.ANSWER).focus();\n  };\n\n  /**\n   * Parse question and set properties found\n   *\n   * @method _parseSubquestion\n   * @private\n   * @param {String} question The question string\n   */\n  const _parseSubquestion = function(question) {\n    const re = /\\{([0-9]*):([_A-Z]+):(.*?)\\}$/g;\n    const parts = re.exec(question);\n    if (!parts) {\n      return;\n    }\n    _marks = parts[1];\n    _qtype = parts[2];\n    _getAnswerDefault();\n    _answerdata = [];\n    const answers = parts[3].match(/(\\\\.|[^~])*/g);\n    if (!answers) {\n      return;\n    }\n    answers.forEach(function(answer) {\n      const options = /^(%(-?[.0-9]+)%|(=?))((\\\\.|[^#])*)#?(.*)/.exec(answer);\n      if (options && options[4]) {\n        if (_qtype === 'NUMERICAL' ||_qtype === 'NM') {\n          const tolerance = /^([^:]*):?(.*)/.exec(options[4])[2] || 0;\n          _answerdata.push({\n            id: crypto.randomUUID(),\n            answer: strdecode(options[4].replace(/:.*/, '')),\n            feedback: strdecode(options[6]),\n            tolerance: tolerance,\n            fraction: options[3] ? 100 : options[2] || 0\n          });\n          return;\n        }\n        _answerdata.push({\n          answer: strdecode(options[4]),\n          id: crypto.randomUUID(),\n          feedback: strdecode(options[6]),\n          fraction: options[3] ? 100 : options[2] || 0\n        });\n      }\n    });\n  };\n\n  /**\n   * Insert a new set of answer blanks before the button.\n   *\n   * @method _addAnswer\n   * @param {Event} e Event from button click or return\n   * @private\n   */\n  const _addAnswer = function(e) {\n    e.preventDefault();\n    let index = _form.querySelectorAll('.' + CSS.ADD).indexOf(e.target);\n    if (index === -1) {\n      index = _form.querySelectorAll('.' + CSS.ANSWER + ', .' + CSS.FEEDBACK).indexOf(e.target);\n      if (index !== -1) {\n        index = Math.floor(index / 2) + 1;\n      }\n    }\n    if (e.target.closest('li')) {\n      _answerDefault = e.target.closest('li').querySelector('.' + CSS.FRACTION).getDOMNode().value;\n      index = _form.querySelectorAll('li').indexOf(e.target.closest('li')) + 1;\n    }\n    let tolerance = 0;\n    if (e.target.closest('li') && e.target.closest('li').querySelector('.' + CSS.TOLERANCE)) {\n      tolerance = e.target.closest('li').querySelector('.' + CSS.TOLERANCE).getDOMNode().value;\n    }\n    _getFormData();\n    _answerdata.splice(index, 0, {\n      id: crypto.randomUUID(),\n      answer: '',\n      feedback: '',\n      fraction: _answerDefault,\n      tolerance: tolerance\n    });\n    modal.setBody(_getDialogueContent(e, _qtype));\n    _form.querySelectorAll('.' + CSS.ANSWER).item(index).focus();\n  };\n\n  /**\n   * Delete set of answer blanks before the button.\n   *\n   * @method _deleteAnswer\n   * @param {Event} e Event from button click\n   * @private\n   */\n  const _deleteAnswer = function(e) {\n    e.preventDefault();\n    let index = _form.querySelectorAll('.' + CSS.DELETE).indexOf(e.target);\n    if (index === -1) {\n      index = _form.querySelectorAll('li').indexOf(e.target.closest('li'));\n    }\n    _getFormData();\n    _answerdata.splice(index, 1);\n    modal.setBody(_getDialogueContent(e, _qtype));\n    const answers = _form.querySelectorAll('.' + CSS.ANSWER);\n    index = Math.min(index, answers.size() - 1);\n    answers.item(index).focus();\n  };\n\n  /**\n   * Lower answer option\n   *\n   * @method _lowerAnswer\n   * @param {Event} e Event from button click\n   * @private\n   */\n  const _lowerAnswer = function(e) {\n    e.preventDefault();\n    const li = e.target.closest('li');\n    li.insertBefore(li.next(), li);\n    li.querySelector('.' + CSS.ANSWER).focus();\n  };\n\n  /**\n   * Raise answer option\n   *\n   * @method _raiseAnswer\n   * @param {Event} e Event from button click\n   * @private\n   */\n  const _raiseAnswer = function(e) {\n    e.preventDefault();\n    const li = e.target.closest('li');\n    li.insertBefore(li, li.previous());\n    li.querySelector('.' + CSS.ANSWER).focus();\n  };\n\n  /**\n   * Reset and hide form.\n   *\n   * @method _cancel\n   * @param {Event} e Event from button click\n   * @private\n   */\n  const _cancel = function(e) {\n    e.preventDefault();\n    modal.hide();\n  };\n\n  /**\n   * Insert content into editor and reset and hide form.\n   *\n   * @method _setSubquestion\n   * @param {Event} e Event from button click\n   * @param {tinymce.Editor} editor\n   * @private\n   */\n  const _setSubquestion = function(e, editor) {\n    e.preventDefault();\n    _getFormData();\n\n    _answerdata.forEach(function(option) {\n      option.answer = strencode(option.answer);\n      option.feedback = strencode(option.feedback);\n    });\n\n    const question = Mustache.render(TEMPLATE.OUTPUT,\n        {CSS: CSS,\n          answerdata: _answerdata,\n          qtype: _qtype,\n          marks: _marks\n        });\n\n    modal.hide();\n    editor.focus();\n    editor.setSelection(_currentSelection);\n\n    // Save the selection before inserting the new question.\n    let selection = window.rangy.saveSelection();\n    editor.insertContent(question);\n    //host.insertContentAtFocusPoint(question);\n\n    // Select the inserted text.\n    window.rangy.restoreSelection(selection);\n  };\n\n  /**\n   * Read and process the current data in the form.\n   *\n   * @method _setSubquestion\n   * @chainable\n   * @return {Object} self\n   * @private\n   */\n  const _getFormData = function() {\n    _answerdata = [];\n    let answer;\n    const answers = _form.querySelectorAll('.' + CSS.ANSWER);\n    const feedbacks = _form.querySelectorAll('.' + CSS.FEEDBACK);\n    const fractions = _form.querySelectorAll('.' + CSS.FRACTION);\n    const tolerances = _form.querySelectorAll('.' + CSS.TOLERANCE);\n    for (let i = 0; i < answers.size(); i++) {\n      answer = answers.item(i).getDOMNode().value;\n      if (this._qtype === 'NM' || this._qtype === 'NUMERICAL') {\n        answer = Number(answer);\n      }\n      _answerdata.push({answer: answer,\n        id: crypto.randomUUID(),\n        feedback: feedbacks.item(i).getDOMNode().value,\n        fraction: fractions.item(i).getDOMNode().value,\n        tolerance: tolerances.item(i) ? tolerances.item(i).getDOMNode().value : 0}\n      );\n      _marks = _form.querySelector('.' + CSS.MARKS).getDOMNode().value;\n    }\n  };\n\n  /**\n   * Locate a node and offset to be used as a end of a range representing an\n   * offset in the text value of a node.\n   * true.\n   *\n   * @method _getAnchor\n   * @param {DOMNode} node Parent node with text value\n   * @param {Integer} offset Position of character with in text of parent node\n   * @return {Object} An object with anchor and offset for the character\n   * with offset in string.\n   * @private\n   */\n  const _getAnchor = function(node, offset) {\n    if (!node.hasChildNodes()) {\n      return {anchor: node, offset: offset};\n    }\n    let child = node.firstChild;\n    while (offset > child.textContent.length) {\n      offset -= child.textContent.length;\n      child = child.nextSibling;\n    }\n    return _getAnchor(child, offset);\n  };\n\n  /**\n   * Find the offset for the text of a child with within the text of parent\n   *\n   * @method _getOffset\n   * @param {DOMNode} container Parent node with text value\n   * @param {DOMNode} node The node at returned offset\n   * @return {Integer} The offset of the child's text\n   * @private\n   */\n  const _getOffset = function(container, node) {\n    if (container === node) {\n      return 0;\n    }\n    if (!container.contains(node)) {\n      return 0;\n    }\n    let offset = 0;\n    let child = container.firstChild;\n    while (!child.contains(node)) {\n      offset += child.textContent.length;\n      child = child.nextSibling;\n    }\n    return offset + _getOffset(child, node);\n  };\n\n  /**\n   * Check whether cursor is in a subquestion and return subquestion text if\n   * true.\n   *\n   * @method resolveSubquestion\n   * @param {inymce.Editor} ed\n   * @return {Mixed} The substring describing subquestion if found\n   */\n  const resolveSubquestion = function(ed) {\n\n    editor = ed;\n    const selectedNode = editor.selection.getStart();\n\n    if (!selectedNode) {\n      return false;\n    }\n\n    const re = /\\{[0-9]*:(\\\\.|[^}])*?\\}/g;\n    const subquestions = selectedNode.textContent.match(re);\n    if (!subquestions) {\n      return false;\n    }\n\n    let index = null;\n    const selection = editor.selection.getContent();\n    let result = '';\n    let questionEnd = 0;\n\n    if (!selection || selection.length === 0) {\n      return false;\n    }\n\n    const startIndex = _getIndex(selectedNode, selection[0].startContainer, selection[0].startOffset);\n    const endIndex = _getIndex(selectedNode, selection[0].endContainer, selection[0].endOffset);\n\n    subquestions.forEach(function(subquestion) {\n      index = selectedNode.textContent.indexOf(subquestion, questionEnd);\n      questionEnd = index + subquestion.length;\n      if (index <= startIndex && endIndex <= questionEnd) {\n        result = subquestion;\n        const startRange = _getAnchor(selectedNode, index);\n        const endRange = _getAnchor(selectedNode, questionEnd);\n        selection[0].setStart(startRange.anchor, startRange.offset);\n        selection[0].setEnd(endRange.anchor, endRange.offset);\n        _currentSelection = selection;\n      }\n    });\n\n    return result;\n  };\n\n  /**\n   * Calculate the position in text of parent node an selection end point.\n   *\n   * @method _getIndex\n   * @param {Node} selectedNode parent node\n   * @param {Node} container selection end point container node\n   * @param {Integer} offset selection end point offset\n   * @return {String} The substring describing subquestion\n   * @private\n   */\n  const _getIndex = function(selectedNode, container, offset) {\n    let index;\n    if (!container.firstChild) {\n      index = _getOffset(selectedNode, container) + offset;\n    } else if (container.childNodes[offset]) {\n      index = _getOffset(selectedNode, container.childNodes[offset]);\n    } else {\n      index = _getOffset(selectedNode, container.lastChild) + container.lastChild.textContent.length;\n    }\n    return index;\n  };\n\nexport {\n  displayDialogue,\n  resolveSubquestion,\n  onInit\n};\n"],"names":["strdecode","t","String","replace","strencode","CSS","ANSWER","ANSWERS","ADD","CANCEL","DELETE","FEEDBACK","FRACTION","LEFT","LOWER","RIGHT","MARKS","DUPLICATE","RAISE","SUBMIT","SUMMARY","TOLERANCE","TYPE","TEMPLATE","FORM","M","util","image_url","OUTPUT","FRACTIONS","fraction","editor","_form","_answerdata","_answerDefault","_qtype","_selectedText","_marks","modal","_currentSelection","ed","async","selection","getContent","toString","ModalFactory","create","type","Modal","title","templateContext","elementid","id","removeOnClose","large","subquestion","resolveSubquestion","_parseSubquestion","setBody","_getDialogueContent","text","show","e","qtype","contentText","Mustache","render","types","content","DOMParser","parseFromString","body","firstElementChild","addEventListener","_choiceHandler","querySelector","_cancel","outerHTML","answerdata","crypto","randomUUID","fractions","marks","numerical","_setSubquestion","target","classList","contains","_deleteAnswer","_addAnswer","_lowerAnswer","_raiseAnswer","_getAnswerDefault","preventDefault","get","currentTarget","hasClass","answer","feedback","tolerance","focus","question","parts","exec","answers","match","forEach","options","push","index","querySelectorAll","indexOf","Math","floor","closest","getDOMNode","value","_getFormData","splice","item","min","size","li","insertBefore","next","previous","hide","option","setSelection","window","rangy","saveSelection","insertContent","restoreSelection","feedbacks","tolerances","i","this","Number","_getAnchor","node","offset","hasChildNodes","anchor","child","firstChild","textContent","length","nextSibling","_getOffset","container","selectedNode","getStart","subquestions","result","questionEnd","startIndex","_getIndex","startContainer","startOffset","endIndex","endContainer","endOffset","startRange","endRange","setStart","setEnd","childNodes","lastChild"],"mappings":"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"}